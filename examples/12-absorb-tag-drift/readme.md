# Example 12: Absorb Tag Drift

This example demonstrates how to use `graft absorb` to automatically generate a graft manifest when resource tags drift outside of Terraform.

## Scenario

You have deployed an Azure Resource Group with two tags (`environment = "test"` and `project = "graft"`). Over time, the tags are modified outside of Terraform:

- Tags changed via Azure CLI:
  ```bash
  az group update --name graft-absorb-test-rg \
    --tags environment=production project=graft owner=drifttest
  ```
- Azure Policy automatically added `Creator` and `DateCreated` tags.

Running `terraform plan` now shows drift:

```
  # azurerm_resource_group.test will be updated in-place
  ~ resource "azurerm_resource_group" "test" {
        id       = "/subscriptions/.../resourceGroups/graft-absorb-test-rg"
        name     = "graft-absorb-test-rg"
      ~ tags     = {
          + "Creator"     = "user@example.com"
          + "DateCreated" = "2026-02-06T13:39:05Z"
          ~ "environment" = "test" -> "production"
          + "owner"       = "drifttest"
            # (1 unchanged element hidden)
        }
    }

Plan: 0 to add, 1 to change, 0 to destroy.
```

Instead of manually writing override blocks, `graft absorb` reads the plan JSON and generates the manifest for you.

## Files

- `main.tf`: Standard Terraform configuration with an Azure Resource Group.
- `plan.json`: Terraform plan JSON output showing the detected drift.
- `absorb.graft.hcl`: The generated graft manifest (output of `graft absorb`).

## Usage

1. Deploy your infrastructure with `terraform apply`.
2. After drift occurs, generate a plan:

   ```bash
   terraform plan -out=tfplan
   terraform show -json tfplan > plan.json
   ```

3. Run `graft absorb` to generate a manifest from the drift:

   ```bash
   graft absorb plan.json

   [+] Fetching providers schema...
   [+] Reading Terraform plan JSON...
   [+] Found 1 resource(s) with drift...
       - azurerm_resource_group.test
   [+] Generating manifest...
   âœ¨ Manifest saved to ./absorb.graft.hcl
   ```

4. Review the generated `absorb.graft.hcl`:

   ```hcl
   # Generated by graft absorb
   # This manifest contains overrides to match the current remote state

   override {
     # Absorb drift for: azurerm_resource_group.test
     resource "azurerm_resource_group" "test" {
       tags = {
         Creator     = "user@example.com"
         DateCreated = "2026-02-06T13:39:05Z"
         environment = "production"
         owner       = "drifttest"
         project     = "graft"
       }
     }
   }
   ```

5. Build and verify:

   ```bash
   graft build
   terraform plan  # should show zero changes
   ```
